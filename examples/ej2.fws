// Ejemplo 2024


network {

    // LAN de clientes

    device pc0 {
        mac = "AA:BB:CC:DD:EE:FF";
        ip = 192.168.0.1;
        subnet = 192.168.0.0/24;
        interfaces = "wlan0";
    }

    device pc1 {
        mac = "AA:BB:CC:DD:EF:FF";
        ip = 192.168.0.2;
        subnet = 192.168.0.0/24;
        interfaces = "wlan0";
    }

     device pc2{
        mac = "AA:BB:CC:DD:01:FF";
        ip = 192.168.0.3;
        subnet = 192.168.0.0/24;
        interfaces = "wlan0";
    }

    // Red de servidores

    device dnswwwSV {
        mac = "AA:BB:CC:CA:FE:FF";
        ip = 168.96.18.1;
        subnet = 168.96.18.0/29;
        interfaces = "eth1";
    }

    device mailSV {
        mac = "AA:BB:CC:CB:FF:FF";
        ip = 168.96.18.2;
        subnet = 168.96.18.0/29;
        interfaces = "eth1";
    }

    device proxySV {
        mac = "AA:BB:CC:CC:FF:FF";
        ip = 168.96.18.3;
        subnet = 168.96.18.0/29;
        interfaces = "eth1";
    }

    // Firewall (clave para que ande el simulador)
    device firewall {
        mac = "AA:BB:CC:CE:FF:FF";
        ip = 45.231.2.17;
        subnet = 45.231.2.0/8;
        interfaces = "eth1", "wlan0", "eth3";
    }
}

packets {
    // una ip desconocida quiere acceder al servicio de dns. aceptar
    p-ext1 : 211.0.0.12 -> 168.96.18.1 : tcp 53120 -> 53 : from "ppp0" to "eth1";

    // la misma quiere acceder ahora a servicios web. aceptar
     p-ext2 : 211.0.0.12 -> 168.96.18.1 : tcp 53121 -> 443 : from "ppp0" to "eth1";

    // la misma quiere acceder ahora a servicios de mail. por default-policy. droppear
     p-ext3 : 211.0.0.12 -> 168.96.18.1 : tcp 53122 -> 995 : from "ppp0" to "eth1";

    // DMZ quiere acceder a la lan, no! reject!
    pdmz-1 : 168.96.18.1 -> 192.168.0.1 : tcp 1111 -> 22 : from "eth1" to "wlan0"; 

    // DMZ quiere acceder a algun lado del internet
    pdmz-2 : 168.96.18.1 -> 224.112.0.9 : tcp 1112 -> 22 : from "eth1" to "ppp2"; 

    // nodo LAN que quiere acceder al dns sin proxy (rechazar)

    plan-1 : 192.168.0.1 -> 168.96.18.1 : udp 3333 ->53 : from "wlan0" to "eth1";

    // nodo LAN que accede al dns con proxy (aceptar)
    plan-2 : 192.168.0.1 -> 168.96.18.3 : udp 3334 -> 53 : from "wlan0" to "eth1";

    // envio intralan (no pasar por firewall)
    plan-3: 192.168.0.2 -> 192.168.0.1 : tcp 2311 -> 22 : from "eth1" to "eth1";

    // envio de lan a internet (no dejar)
    plan4 : 192.168.0.3 -> 31.11.23.12 : tcp 2444 -> 22 : from "wlan0" to "eth3";

    // envio random (?) no deberia pasar x firewall tampoco

    prandom : 55.34.34.1 -> 22.11.22.44 : tcp 3434 -> 22: from "ppp1" to "wlan0";


}

rules {

    // Los clientes de la LAN: 
    // Solo pueden consultar DNS (TCP/UDP 53) a los servidores de la DMZ, no a los de Internet
    // Solo pueden acceder a los puertos necesarios de los servidores de la DMZ (SMTP, MAPs, POPs, WEB, DNS) y nada mas

    //  Los servidores de la DMZ tienen acceso total a Internet pero no a la LAN

    // Desde el exterior, se puede acceder los servicios DNS, WEB y al servicio SMTP de transferencia (solo TCP 25) de los servidores
    // correspondientes.

    chain FORWARD {
        // reglas LAN
        -srcsubnet 192.168.0.0/24 -prot tcp -dstp 25,587,465,995 -dstip 168.96.18.1 -do ACCEPT;
        -srcsubnet 192.168.0.0/24 -prot tcp -dstp 80,443 -dstip 168.96.18.3 -do ACCEPT;
        -srcsubnet 192.168.0.0/24 -prot any -dstp 53 -dstip 168.96.18.3 -do ACCEPT;
        -srcsubnet 192.168.0.0/24 -prot any -dstip 168.96.18.1 -do REJECT;

        // el resto de los envios de la lan caen a la default policy

        // bloquear accesos DMZ -> LAN
        -srcsubnet 168.96.18.0/29 -dstsubnet 192.168.0.0/24 -inif "eth1" -outif "wlan0" -do REJECT;

        // el resto de accesos se asumen permitidos, DMZ -> ? (obs que no nateamos)
        -srcsubnet 168.96.18.0/29 -inif "eth1" -do ACCEPT;

        // admitir accesos DNS/WEB/SMTP desde el exterior
        -dstip 168.96.18.1 -outif "eth1" -inif "eth3" -dstp 53 -prot any -do ACCEPT; // dns 
        -dstip 168.96.18.1 -outif "eth1" -inif "eth3" -dstp 80, 443 -prot tcp -do ACCEPT; // http, https
        -dstip 168.96.18.2 -outif "eth1" -inif "eth3" -dstp 25 -prot tcp -do ACCEPT ;// smtp
        
        -default ACCEPT;
    
    }


}


