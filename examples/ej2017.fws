// Ejemplo 2017


subnets {
    subnet LAN {
        range = 10.23.0.0/16;
        interface = "eth2";
    }

    subnet SERVERS {
        range =10.10.0.0/22;
        interface = "eth1";
    }

    subnet DMZ {
        range =10.1.1.0/29;
        interface = "eth0";
    }
}


devices {

    // LAN

    device pcA {
        mac = "AA:BB:CC:DD:EE:FE";
        ip =  10.23.1.1;
        subnet = LAN;
    }

    device pcB {
        mac = "AA:BB:CC:DD:EE:FF";
        ip =  10.23.2.1;
        subnet = LAN;
    }


     device ADMIN {
        mac = "AA:BB:CE:DD:EE:FF";
        ip =  10.23.23.5;
        subnet =  LAN;
    }

    // Red de servidores

    device Dbserver {
        mac = "AA:BB:CA:FE:CA:FE";
        ip = 10.10.1.2;
        subnet = SERVERS;
    }

    device Mailserver {
        mac = "AA:cc:CA:FE:CA:FE";
        ip = 10.10.1.3;
        subnet = SERVERS;

    }

    // DMZ

    device WebServer {
        mac = "AA:dd:CA:FE:CA:FE";
        ip = 10.1.1.2;
        subnet = DMZ;

    }
    
    device Mailrelay {
        mac = "AA:ee:CA:FE:CA:FE";
        ip = 10.1.1.3;
        subnet = DMZ;
    }

    // Firewall 
    device firewall {
        mac = "AA:ff:CA:FE:CA:FE";
        publicip = 200.123.131.112;
    }
}

packets {
    // ==================== FORWARD CHAIN TESTS ====================
    
    // 1. LAN -> MailServer POP3 (debe ACCEPT - regla 1)
    p-lan-mail-pop3: 10.23.1.1 -> 10.10.1.3 : tcp 1024 -> 110 : from "eth2" to "eth1";
    
    // 2. LAN -> MailServer IMAP (debe ACCEPT - regla 1)
    p-lan-mail-imap: 10.23.2.1 -> 10.10.1.3 : tcp 1025 -> 143 : from "eth2" to "eth1";
    
    // 3. LAN -> DbServer HTTPS (debe ACCEPT - regla 2)
    p-lan-db-https: 10.23.1.1 -> 10.10.1.2 : tcp 1026 -> 443 : from "eth2" to "eth1";
    
    // 4. LAN -> WebServer DNS (debe ACCEPT - regla 3)
    p-lan-web-dns: 10.23.2.1 -> 10.1.1.2 : udp 1027 -> 53 : from "eth2" to "eth0";
    
    // 5. LAN -> WebServer HTTP (debe REJECT - regla 4)
    p-lan-web-http: 10.23.1.1 -> 10.1.1.2 : tcp 1028 -> 80 : from "eth2" to "eth0";
    
    // 6. LAN -> Mailrelay SMTP (debe REJECT - regla 5)
    p-lan-mailrelay-smtp: 10.23.2.1 -> 10.1.1.3 : tcp 1029 -> 25 : from "eth2" to "eth0";
    
    // 7. MailServer -> Mailrelay DNS (debe ACCEPT - regla 6, TCP)
    p-mail-mailrelay-dns-tcp: 10.10.1.3 -> 10.1.1.3 : tcp 1030 -> 53 : from "eth1" to "eth0";
    
    // 8. MailServer -> Mailrelay DNS (debe ACCEPT - regla 7, UDP)
    p-mail-mailrelay-dns-udp: 10.10.1.3 -> 10.1.1.3 : udp 1031 -> 53 : from "eth1" to "eth0";
    
    // 9. MailServer -> Mailrelay SMTPS (debe ACCEPT - regla 6)
    p-mail-mailrelay-smtps: 10.10.1.3 -> 10.1.1.3 : tcp 1032 -> 465 : from "eth1" to "eth0";
    
    // 10. Mailrelay -> MailServer SMTPS (debe ACCEPT - regla 8)
    p-mailrelay-mail-smtps: 10.1.1.3 -> 10.10.1.3 : tcp 1033 -> 465 : from "eth0" to "eth1";
    
    // 11. WebServer -> DbServer MySQL (debe ACCEPT - regla 9)
    p-web-db-mysql: 10.1.1.2 -> 10.10.1.2 : tcp 1034 -> 3306 : from "eth0" to "eth1";
    
    // 12. LAN -> Internet HTTP (debe ACCEPT - regla 10)
    p-lan-internet-http: 10.23.1.1 -> 8.8.8.8 : tcp 1035 -> 80 : from "eth2" to "eth3";
    
    // 13. Internet -> Mailrelay DNS (debe ACCEPT - regla 11)
    p-internet-mailrelay-dns: 200.100.50.25 -> 10.1.1.3 : udp 1036 -> 53 : from "eth3" to "eth0";
    
    // 14. Internet -> Mailrelay SMTP (debe ACCEPT - regla 12)
    p-internet-mailrelay-smtp: 200.100.50.25 -> 10.1.1.3 : tcp 1037 -> 25 : from "eth3" to "eth0";
    
    // 15. Internet -> WebServer HTTP (debe ACCEPT - regla 13)
    p-internet-web-http: 200.100.50.25 -> 10.1.1.2 : tcp 1038 -> 80 : from "eth3" to "eth0";
    
    // 16. Internet -> WebServer HTTPS (debe ACCEPT - regla 13)
    p-internet-web-https: 200.100.50.25 -> 10.1.1.2 : tcp 1039 -> 443 : from "eth3" to "eth0";
    
    // 17. DMZ -> Internet DNS (debe ACCEPT - regla 14)
    p-dmz-internet-dns: 10.1.1.2 -> 8.8.8.8 : udp 1040 -> 53 : from "eth0" to "eth3";
    
    // 18. Mailrelay -> Internet SMTP (debe ACCEPT - regla 15)
    p-mailrelay-internet-smtp: 10.1.1.3 -> 8.8.8.8 : tcp 1041 -> 25 : from "eth0" to "eth3";
    
    // 19. WebServer -> Internet HTTP (debe DROP - no permitido)
    p-web-internet-http: 10.1.1.2 -> 8.8.8.8 : tcp 1042 -> 80 : from "eth0" to "eth3";
    
    // ==================== INPUT CHAIN TESTS ====================
    
    // 20. Admin -> Firewall SSH (debe ACCEPT - regla 16)
    p-admin-firewall-ssh: 10.23.23.5 -> 200.123.131.112 : tcp 1043 -> 22 : from "eth2" to "";
    
    // 21. LAN -> Firewall SSH (debe REJECT - regla 17)
    p-lan-firewall-ssh: 10.23.1.1 -> 200.123.131.112 : tcp 1044 -> 22 : from "eth2" to "";
    
    // 22. MailServer -> Firewall (debe REJECT - regla 18)
    p-mail-firewall: 10.10.1.3 -> 200.123.131.112 : tcp 1045 -> 22 : from "eth1" to "";
    
    // 23. WebServer -> Firewall (debe REJECT - regla 19)
    p-web-firewall: 10.1.1.2 -> 200.123.131.112 : tcp 1046 -> 22 : from "eth0" to "";
    
    // 24. Internet -> Firewall (debe REJECT - default)
    p-internet-firewall: 200.100.50.25 -> 200.123.131.112 : tcp 1047 -> 22 : from "eth3" to "";
    
    // ==================== OUTPUT CHAIN TESTS ====================
    
    // 25. Firewall -> WebServer DNS (debe ACCEPT - regla 20)
    p-firewall-web-dns: 200.123.131.112 -> 10.1.1.2 : udp 1048 -> 53 : from "" to "eth0";
    
    // 26. Firewall -> LAN (debe REJECT - regla 21)
    p-firewall-lan: 200.123.131.112 -> 10.23.1.1 : tcp 1049 -> 22 : from "" to "eth2";
    
    // 27. Firewall -> MailServer (debe REJECT - regla 22)
    p-firewall-mail: 200.123.131.112 -> 10.10.1.3 : tcp 1050 -> 22 : from "" to "eth1";
    
    // 28. Firewall -> Internet (debe DROP - default)
    p-firewall-internet: 200.123.131.112 -> 8.8.8.8 : tcp 1051 -> 53 : from "" to "eth3";
    
    // ==================== SPECIAL CASES ====================
    
    // 29. Intra-subnet LAN (debe aceptarse sin pasar por firewall)
    p-intra-lan: 10.23.1.1 -> 10.23.2.1 : tcp 1052 -> 22 : from "eth2" to "eth2";
    
    // 30. Internet a Internet (debe aceptarse sin pasar por firewall)
    p-internet-internet: 8.8.8.8 -> 1.1.1.1 : tcp 1053 -> 80 : from "ppp0" to "ppp1";
    
    // 31. Admin -> DbServer (debe ACCEPT por regla 4/5)
    p-admin-db: 10.23.23.5 -> 10.10.1.2 : tcp 1054 -> 443 : from "eth2" to "eth1";


    // 32. LAN -> Internet con interfaz de salida ETH2 (incorrecta - debe ser ETH3)
    p-lan-internet-wrong-out: 10.23.1.1 -> 8.8.8.8 : tcp 1055 -> 80 : from "eth2" to "eth2";
    
    // 33. LAN -> Internet sin especificar interfaz de salida
    p-lan-internet-no-out: 10.23.2.1 -> 1.1.1.1 : tcp 1056 -> 443 : from "eth2" to "";
    
    // 34. DMZ -> Internet DNS con interfaz ETH1 (incorrecta)
    p-dmz-internet-wrong-out: 10.1.1.2 -> 8.8.8.8 : udp 1057 -> 53 : from "eth0" to "eth1";
    
    // 35. Mailrelay -> Internet SMTP con interfaz ETH0 (incorrecta)
    p-mailrelay-internet-wrong-out: 10.1.1.3 -> 8.8.8.8 : tcp 1058 -> 25 : from "eth0" to "eth0";
    
    // ============ INTERFACES INCORRECTAS DESDE INTERNET ============
    
    // 36. Internet -> DMZ con interfaz ETH2 (incorrecta - debe ser ETH3)
    p-internet-dmz-wrong-in: 200.100.50.25 -> 10.1.1.2 : tcp 1059 -> 80 : from "eth2" to "eth0";
    
    // 37. Internet -> Mailrelay sin interfaz de entrada
    p-internet-mailrelay-no-in: 200.100.50.26 -> 10.1.1.3 : tcp 1060 -> 25 : from "" to "eth0";
    
    // 38. Internet -> WebServer con interfaz ETH1
    p-internet-web-wrong-in: 200.100.50.27 -> 10.1.1.2 : tcp 1061 -> 443 : from "eth1" to "eth0";
    
    // ============ CASOS MIXTOS CON AMBAS INTERFACES INCORRECTAS ============
    
    // 39. Internet -> DMZ con ambas interfaces incorrectas
    p-internet-dmz-both-wrong: 200.100.50.28 -> 10.1.1.3 : udp 1062 -> 53 : from "eth2" to "eth2";
    
    // 40. LAN -> Internet con ambas interfaces incorrectas
    p-lan-internet-both-wrong: 10.23.1.1 -> 9.9.9.9 : tcp 1063 -> 22 : from "eth1" to "eth0";

}

rules {

   
    chain FORWARD {
         // Las PC de la LAN tienen acceso al correo electronico en la red de servidores (110 pop3, 143 imap - tcp)
        // a la aplicacion web de negocios en el dbserver por https
        // Asimismo pueden acceder al DNS de la DMZ, y a nada mas de las redes internas
        -srcsubnet 10.23.0.0/16 -dstip 10.10.1.3 -prot tcp -dstp 110,143 -outif "eth1" -inif "eth2" -do ACCEPT;
        -srcsubnet 10.23.0.0/16 -dstip 10.10.1.2 -prot tcp -dstp 443 -inif "eth2" -outif "eth1" -do ACCEPT;
        -srcsubnet 10.23.0.0/16 -dstip 10.1.1.2 -dstsubnet 10.1.1.0/29 -prot any -dstp 53 -inif "eth2" -outif "eth0" -do ACCEPT;
        
        -srcsubnet 10.23.0.0/16 -inif "eth2" -dstsubnet 10.1.1.0/29 -do REJECT;
        -srcsubnet 10.23.0.0/16 -inif "eth2" -dstsubnet 10.10.0.0/22 -do REJECT;


        // El servidor de mail de la red de servidores tiene acceso al dns y al puerto 465/tcp (smtps) del relay.
        -srcip 10.10.1.3 -srcsubnet 10.10.0.0/22 -inif "eth1" -outif "eth0" -dstip 10.1.1.3 -dstsubnet 10.1.1.0/29 -prot tcp -dstp 53,465 -do ACCEPT;
        -srcip 10.10.1.3 -srcsubnet 10.10.0.0/22 -inif "eth1" -outif "eth0" -dstip 10.1.1.3 -dstsubnet 10.1.1.0/29 -prot udp -dstp 53 -do ACCEPT;

        // El relay tiene acceso al puerto 465/tcp del servidor de mail
        -srcip 10.1.1.3 -dstip 10.10.1.3 -prot tcp -dstp 465 -do ACCEPT;

        // el webserver de la dmz tiene acceso al puerto 3306/tcp (mysql) del dbserver.
        -srcip 10.1.1.2 -dstip 10.10.1.2 -inif "eth0" -srcsubnet 10.1.1.0/29 -outif "eth1" -dstsubnet 10.10.0.0/22 -dstp 3306 -prot tcp -do ACCEPT; 

        // Las pc pueden navegar libremente por internet.
        -srcsubnet 10.23.0.0/16 -inif "eth2" -outif "eth3" -do ACCEPT;

        // Desde internet es posible acceder a los siguientes servicios de la DMZ: Mailrelay 53 udp y tcp
     //(DNS) y 25 (SMTP), y a los puertos 80 y 443 del webserver, --- a través de la única IP pública. ---
        -inif "eth3" -dstsubnet 10.1.1.0/29 -dstip 10.1.1.3 -prot any -dstp 53 -do ACCEPT;
        -inif "eth3" -dstsubnet 10.1.1.0/29 -dstip 10.1.1.3 -prot tcp -dstp 25 -do ACCEPT;
        -inif "eth3" -dstsubnet 10.1.1.0/29 -dstip 10.1.1.2 -prot tcp -dstp 80,443 -do ACCEPT;

        //  Los servidores de la DMZ pueden consultar DNS a internet y el RELAY puede enviar correo a
        // Internet a traves del puerto 25/tcp
        -outif "eth3" -inif "eth0" -srcsubnet 10.1.1.0/29 -prot any -dstp 53 -do ACCEPT;
        -outif "eth3" -inif "eth0" -srcsubnet 10.1.1.0/29 -srcip 10.1.1.3 -prot tcp -dstp 25 -do ACCEPT;
        -default DROP;

    }
    //  En cuanto al firewall en si, sólo es posible ingresar desde la PC del administrador, 10.23.23.5
// por ssh. Desde el firewall, solo se puede consultar dns en el servidor de la DMZ

    chain INPUT {
        -srcip 10.23.23.5 -srcsubnet 10.23.0.0/16 -dstip 200.123.131.112 -inif "eth2" -do ACCEPT;
        -srcsubnet 10.23.0.0/16 -do REJECT;
        -srcsubnet 10.10.0.0/22 -do REJECT;
        -srcsubnet 10.1.1.0/29  -do REJECT;
        -default DROP;
    }

    //  Desde el firewall, solo se puede consultar dns en el servidor de la DMZ.

    chain OUTPUT {
        -srcip 200.123.131.112 -dstsubnet 10.1.1.0/29 -dstip 10.1.1.2 -outif "eth0" -dstp 53 -prot any -do ACCEPT;
        -dstsubnet 10.23.0.0/16 -do REJECT;
        -dstsubnet 10.10.0.0/22 -do REJECT;
        -dstsubnet 10.1.1.0/29  -do REJECT;
        -default DROP;
    }


    // No hay más accesos que los especificados.

}